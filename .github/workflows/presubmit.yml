on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    - cron: '0 12 * * 0'

jobs:
  ubuntu_tests:
    name: Test Sammy on Ubuntu
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version: [3.9]
    steps:
      - uses: actions/checkout@v2
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v2

      - name: ğŸ“¥ Install Sammy Dependencies
        run: sudo python3 setup.py install

      - name: âœ¨ Make a new project
        run: sammy start project

      - name: âœ‚ï¸ Copy main.cpp ğŸ“‹ app.cpp
        working-directory: project
        run: cp main.cpp app.cpp

      - name: ğŸ› ï¸ Build Application (lpc40xx)
        working-directory: project
        run: |
              sammy build
              test -f ./build/lpc40xx/./lpc40xx.main.cpp.elf

      - name: ğŸ› ï¸ Build Application (lpc40xx) given source file
        working-directory: project
        run: |
              sammy build app.cpp
              test -f ./build/lpc40xx/./lpc40xx.app.cpp.elf

      - name: ğŸ› ï¸ Build Application (stm32f10x) given source file
        working-directory: project
        run: |
              sammy build app.cpp -Os --platform stm32f10x
              test -f ./build/stm32f10x/./stm32f10x.app.cpp.elf

      - name: ğŸ“¦ Install libbasis
        working-directory: project
        run: |
              sammy install libbasis

      - name: ğŸ—‘ï¸ Remove libbasis
        working-directory: project
        run: |
              sammy remove libbasis

  osx_tests:
    name: Test Sammy on OSX
    runs-on: macos-10.15
    strategy:
      matrix:
        python-version: [3.9]
    steps:
      - uses: actions/checkout@v2
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          python-version: ${{ matrix.python-version }}

      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Install Sammy Dependencies
        run: sudo python3 setup.py install

      - name: ğŸ˜´ Sleep 10s (prevent GitHub API errors)
        run: sleep 10

      - name: âœ¨ Make a new project
        run: sammy start project

      - name: âœ‚ï¸ Copy main.cpp ğŸ“‹ app.cpp
        working-directory: project
        run: cp main.cpp app.cpp

      - name: ğŸ› ï¸ Build Application (lpc40xx)
        working-directory: project
        run: |
              sammy build
              test -f ./build/lpc40xx/./lpc40xx.main.cpp.elf

      - name: ğŸ› ï¸ Build Application (lpc40xx) given source file
        working-directory: project
        run: |
              sammy build app.cpp
              test -f ./build/lpc40xx/./lpc40xx.app.cpp.elf

      - name: ğŸ› ï¸ Build Application (stm32f10x) given source file
        working-directory: project
        run: |
              sammy build app.cpp -Os --platform stm32f10x
              test -f ./build/stm32f10x/./stm32f10x.app.cpp.elf

      - name: ğŸ“¦ Install libbasis
        working-directory: project
        run: |
              sammy install libbasis

      - name: ğŸ—‘ï¸ Remove libbasis
        working-directory: project
        run: |
              sammy remove libbasis


  windows_tests:
    name: Test Sammy on Windows
    runs-on: windows-2019
    strategy:
      matrix:
        python-version: [3.9]
    steps:
      - uses: actions/checkout@v2
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v2

      - name: ğŸ“¥ Install Sammy Dependencies
        run: python3 setup.py install

      - name: âœ¨ Make a new project
        run: sammy start project

      - name: âœ‚ï¸ Copy main.cpp ğŸ“‹ app.cpp
        working-directory: project
        run: cp main.cpp app.cpp

      - name: ğŸ› ï¸ Build Application (lpc40xx)
        working-directory: project
        run: |
              sammy build
              test -f ./build/lpc40xx/./lpc40xx.main.cpp.elf

      - name: ğŸ› ï¸ Build Application (lpc40xx) given source file
        working-directory: project
        run: |
              sammy build app.cpp
              test -f ./build/lpc40xx/./lpc40xx.app.cpp.elf

      - name: ğŸ› ï¸ Build Application (stm32f10x) given source file
        working-directory: project
        run: |
              sammy build app.cpp -Os --platform stm32f10x
              test -f ./build/stm32f10x/./stm32f10x.app.cpp.elf

      - name: ğŸ“¦ Install libbasis
        working-directory: project
        run: |
              sammy install libbasis

      - name: ğŸ—‘ï¸ Remove libbasis
        working-directory: project
        run: sammy remove libbasis
